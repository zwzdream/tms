<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.wistronits.tms.dao.IResumeDao">
	<resultMap id="BaseResultMap" type="com.wistronits.tms.entity.ResumeBean">
		<id column="id" property="id" jdbcType="INTEGER" />
		<result column="firstname" property="firstname" jdbcType="VARCHAR" />
		<result column="lastname" property="latname" jdbcType="VARCHAR" />
	</resultMap>

	<resultMap id="ResumeBeanResultMap" type="com.wistronits.tms.entity.ResumeBean">
		<id column="id" property="id" jdbcType="INTEGER" />
		<result column="first_name" property="firstName" jdbcType="VARCHAR" />
		<result column="last_name" property="lastName" jdbcType="VARCHAR" />
		<result column="birth" property="birth" jdbcType="DATE" />
		<result column="gender" property="gender" jdbcType="BOOLEAN" />
		<result column="mobile" property="mobile" jdbcType="VARCHAR" />
		<result column="starts" property="starts" jdbcType="DATE" />
		<result column="email" property="email" jdbcType="VARCHAR" />
		<result column="residency" property="residency" jdbcType="VARCHAR" />
		<result column="education" property="education" jdbcType="VARCHAR" />
		<result column="workExp" property="workExp" jdbcType="VARCHAR" />
		<result column="projectExp" property="projectExp" jdbcType="VARCHAR" />
		<result column="last_m_time" property="lastMTime" jdbcType="DATE"/>
	</resultMap>
	<resultMap id="ImportResourceBeanResultMap" type="com.wistronits.tms.entity.ImportResourceBean">
		<id column="id" property="id" jdbcType="INTEGER" />
		<result column="first_name" property="firstName" jdbcType="VARCHAR" />
		<result column="last_name" property="lastName" jdbcType="VARCHAR" />
		<result column="birth" property="birth" jdbcType="DATE" />
		<result column="gender" property="gender" jdbcType="BOOLEAN" />
		<result column="file_path" property="filePath" jdbcType="VARCHAR" />
		<result column="type" property="type" jdbcType="VARCHAR"/>
		<result column="last_m_time" property="lastMTime" jdbcType="DATE"/>
	</resultMap>
	
	<resultMap id="ADddResourceBeanResultMap" type="com.wistronits.tms.entity.ImportResourceBean">
		<id column="id" property="id" jdbcType="INTEGER" />
		<result column="first_name" property="firstName" jdbcType="VARCHAR" />
		<result column="last_name" property="lastName" jdbcType="VARCHAR" />
		<result column="birth" property="birth" jdbcType="DATE" />
		<result column="gender" property="gender" jdbcType="BOOLEAN" />
		<result column="type" property="type" jdbcType="VARCHAR"/>
		<result column="last_m_time" property="lastMTime" jdbcType="DATE"/>
	</resultMap>

	<insert id="addResume" parameterType="com.wistronits.tms.entity.ResumeBean" useGeneratedKeys="true" keyProperty="id">
       insert into resume (id,first_name, last_name,birth,gender,mobile,starts,email,residency,education,workExp,projectExp,last_m_time)
     		values (#{id,jdbcType=INTEGER},#{firstName,jdbcType=VARCHAR}, #{lastName,jdbcType=VARCHAR},#{birth,jdbcType=DATE},
     		#{gender,jdbcType=BOOLEAN},#{mobile,jdbcType=VARCHAR},#{starts,jdbcType=DATE},#{email,jdbcType=VARCHAR},#{residency,jdbcType=VARCHAR},
     		#{education,jdbcType=VARCHAR},#{workExp,jdbcType=VARCHAR},#{projectExp,jdbcType=VARCHAR},#{lastMTime,jdbcType=DATE}
     		)
     </insert>

	
	<insert id="insertResource" parameterType="com.wistronits.tms.entity.ImportResourceBean" 
	useGeneratedKeys="true" keyProperty="id">
         insert into import_resource (first_name, last_name, birth,gender,file_path,last_m_time)
     		values (#{firstName,jdbcType=VARCHAR}, #{lastName,jdbcType=VARCHAR}, #{birth,jdbcType=DATE}, 
       			#{gender,jdbcType=BOOLEAN},#{filePath,jdbcType=VARCHAR},#{lastMTime,jdbcType=DATE})
     </insert>
     
     <select id="getAllImportBeans" resultMap="ImportResourceBeanResultMap">
     	select * from import_resource
     </select>
     
     <select id="getImportResourceByIds" resultMap="ImportResourceBeanResultMap" >
     	select *,'import' as 'type' from import_resource where id in 
     	<foreach item="item" index="index" collection="list" open="(" separator="," close=")">  
  			#{item}  
 		</foreach>
     </select>
     
     <select id="getAllImportBeansCount" resultType="int">
     	select count(*) from import_resource
     </select>
     
     <select id="getAddResourceByIds" resultMap="ADddResourceBeanResultMap">
     	select id,first_name,last_name,birth,gender,last_m_time,'add' as 'type' from resume where id in 
     	<foreach item="item" index="index" collection="list" open="(" separator="," close=")"> 
     		#{item}
     	</foreach>
     </select>
     
     <select id="getAllBeans" resultMap="ImportResourceBeanResultMap">
     	select id,first_name,last_name,birth,gender,last_m_time,'import' as 'type' from import_resource
     	UNION ALL
     	select id,first_name,last_name,birth,gender,last_m_time,'add' as 'type' from resume 
     </select>
     
     <select id="getBeansByIds" parameterType="Map" resultMap="ImportResourceBeanResultMap">
     	<if test="importList!=null and importList.size()!=0">
     	select id,first_name,last_name,birth,gender,'import' as 'type' from import_resource  where id in
     	<foreach item="importItem" index="importIndex" collection="importList" open="(" separator="," close=")"> 
     		#{importItem}
     	</foreach>
     	</if>
     	<if test="addList!=null and addList.size()!=0 and importList!=null and importList.size()!=0">
     	UNION ALL
     	</if>
     	
     	<if test="addList!=null and addList.size()!=0">
     	select id,first_name,last_name,birth,gender,'add' as 'type' from resume where id in
     	<foreach item="addItem" index="addIndex" collection="addList" open="(" separator="," close=")"> 
     		#{addItem}
     	</foreach>
     	</if>
     
     </select>
     
     <select id="getAllBeansCount" resultType="int">
     	select count(*) from 
		(select id,first_name,last_name,birth,gender,last_m_time,'import' as 'type' from import_resource 
     	 UNION ALL
     	 select id,first_name,last_name,birth,gender,last_m_time,'add' as 'type' from resume) temp
     </select>
     
     <delete id="deleteImportResource" parameterType="int">
     	delete from import_resource where id=#{id}
     </delete>
     <delete id="deleteResume" parameterType="int">
     	delete from resume where id=#{id}
     </delete>
     
     <select id="getImportResourceById" parameterType="int" resultMap="ImportResourceBeanResultMap">
     	select * from import_resource where id=#{id}
     </select>
     <select id="getResumeById" parameterType="int" resultMap="ResumeBeanResultMap">
     	select * from resume where id=#{id}
     </select>
     <update id="editImportResource" parameterType="com.wistronits.tms.entity.ImportResourceBean" >
	
	update import_resource set first_name=#{firstName},last_name=#{lastName},birth=#{birth},gender=#{gender},file_path=#{filePath},last_m_time=#{lastMTime} where id=#{id} 

	</update>
     <update id="editResume" parameterType="com.wistronits.tms.entity.ResumeBean" >
	
	update resume set first_name=#{firstName},last_name=#{lastName},birth=#{birth},gender=#{gender},mobile=#{mobile},
	starts=#{starts},email=#{email},residency=#{residency},workExp=#{workExp},projectExp=#{projectExp},last_m_time=#{lastMTime} where id=#{id} 

	</update>
	<select id="getCurrentWeekCount" resultType="int">
		select count(*) from 
		(select id from import_resource where last_m_time>DATE_SUB(CURDATE(), INTERVAL 1 WEEK)
     	 UNION ALL
     	 select id from resume where last_m_time>DATE_SUB(CURDATE(), INTERVAL 1 WEEK)) temp
	</select>
	
	
<!-- 	<select id="haveResumes" resultMap="ImportResourceBeanResultMap">
     	SELECT a.id,a.first_name,a.last_name,a.birth,a.gender,a.last_m_time,'add' as 'type'
     	FROM RESUME a LEFT JOIN jd_resume_resource b ON a.id=b.add_id LEFT JOIN jd c ON b.jd_id=c.no WHERE c.no=#{no} ORDER BY id
     </select>
	<select id="haveNotResumes" resultMap="ImportResourceBeanResultMap">
     	 SELECT a.id,a.first_name,a.last_name,a.birth,a.gender,a.last_m_time,'add' AS 'type'
     	FROM RESUME a WHERE  NOT EXISTS (SELECT b.add_id FROM jd_resume_resource b WHERE b.jd_id=#{no} AND a.id=b.add_id) ORDER BY id 
     </select>
     
	<select id="haveImportBeans" resultMap="ImportResourceBeanResultMap">
     	SELECT a.id,a.first_name,a.last_name,a.birth,a.gender,a.last_m_time,'import' as 'type'
     	FROM import_resource a LEFT JOIN jd_resume_resource b ON a.id=b.import_id LEFT JOIN jd c ON b.jd_id=c.no WHERE c.no=#{no} ORDER BY id
     </select>
	<select id="haveNotImportBeans" resultMap="ImportResourceBeanResultMap">
	
     SELECT a.id,a.first_name,a.last_name,a.birth,a.gender,a.last_m_time,'import' AS 'type'
     	FROM import_resource a WHERE  NOT EXISTS (SELECT b.import_id FROM jd_resume_resource b WHERE b.jd_id=#{no} AND a.id=b.import_id) ORDER BY id
     </select> -->
     
     <select id="haveBeans" resultMap="ImportResourceBeanResultMap">
        SELECT a.id,a.first_name,a.last_name,a.birth,a.gender,a.last_m_time,'add' as 'type'
     	FROM RESUME a LEFT JOIN jd_resume_resource b ON a.id=b.add_id LEFT JOIN jd c ON b.jd_id=c.no WHERE c.no=#{no} 
     	UNION ALL
     	SELECT a.id,a.first_name,a.last_name,a.birth,a.gender,a.last_m_time,'import' as 'type'
     	FROM import_resource a LEFT JOIN jd_resume_resource b ON a.id=b.import_id LEFT JOIN jd c ON b.jd_id=c.no WHERE c.no=#{no} 
     </select>
	<select id="haveNotBeans" resultMap="ImportResourceBeanResultMap">
		SELECT a.id,a.first_name,a.last_name,a.birth,a.gender,a.last_m_time,'add' AS 'type'
     	FROM RESUME a WHERE  NOT EXISTS (SELECT b.add_id FROM jd_resume_resource b WHERE b.jd_id=#{no} AND a.id=b.add_id) 
     	UNION ALL
        SELECT a.id,a.first_name,a.last_name,a.birth,a.gender,a.last_m_time,'import' AS 'type'
     	FROM import_resource a WHERE  NOT EXISTS (SELECT b.import_id FROM jd_resume_resource b WHERE b.jd_id=#{no} AND a.id=b.import_id) 
     </select>
     
     <update id="editBelongResumeResource">	
	update jd_resume_resource set add_id=#{1} where jd_id=#{0} 
	</update>
     <update id="editBelongImportResource">	
	update jd_resume_resource set import_id=#{1} where jd_id=#{0} 
	</update>
	
	<insert id="addResumeResourceToJD" >
	  insert into jd_resume_resource(jd_id,add_id) values(#{0},#{1})  
	</insert>
	<insert id="addImportResourceToJD" >
	  insert into jd_resume_resource(jd_id,import_id) values(#{0},#{1})  
	</insert>
	
	 <delete id="deleteImportResourceFromJD">
     	delete from jd_resume_resource where jd_id=#{0} and import_id=#{1}
     </delete>
	 <delete id="deleteResumeResourceFromJD">
     	delete from jd_resume_resource where jd_id=#{0} and add_id=#{1}
     </delete>
     
     <select id="getAddIdsByNo" resultType="int">
     SELECT add_id FROM jd_resume_resource WHERE add_id IS NOT NULL AND jd_id=#{no}
	</select>
     <select id="getImportIdsByNo" resultType="int">
     SELECT import_id FROM jd_resume_resource WHERE import_id IS NOT NULL  AND jd_id=#{no}
	</select>
</mapper>